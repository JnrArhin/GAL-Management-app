{% extends "base.html" %}
{% block content %}
<div class="ai-employees-container">
    <h2>AI Employees Dashboard</h2>
    
    <!-- Add New AI Employee Form -->
    <div class="add-ai-form">
        <h3>Add New AI Employee</h3>
        <form id="addAIForm">
            <input type="text" name="name" placeholder="AI Name" required>
            <select name="role" required>
                <option value="data_analyst">Data Analyst</option>
                <option value="safety_officer">Safety Officer</option>
                <option value="maintenance_supervisor">Maintenance Supervisor</option>
                <option value="environmental_monitor">Environmental Monitor</option>
            </select>
            <input type="text" name="skills" placeholder="Skills (comma-separated)">
            <button type="submit">Add AI Employee</button>
        </form>
    </div>

    <!-- Reports Section -->
    <div class="reports-section">
        <h3>AI Generated Reports</h3>
        <div class="reports-filters">
            <select id="reportTypeFilter">
                <option value="all">All Reports</option>
                <option value="safety">Safety Reports</option>
                <option value="maintenance">Maintenance Reports</option>
                <option value="environmental">Environmental Reports</option>
                <option value="data">Data Analysis Reports</option>
            </select>
            <input type="date" id="dateFilter">
        </div>
        <div class="reports-list" id="reportsList">
            <!-- Reports will be populated here dynamically -->
        </div>
    </div>

    <!-- AI Employees List -->
    <div class="ai-employees-list">
        {% for ai in ai_employees %}
        <div class="ai-employee-card">
            <h4>{{ ai.name }}</h4>
            <p>Role: {{ ai.role }}</p>
            <p>Status: {{ ai.status }}</p>
            <p>Skills: {{ ai.skills }}</p>
            <p>Last Active: {{ ai.last_active.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <button onclick="assignTask('{{ ai.id }}')">Assign Task</button>
            <div class="task-response" id="response-{{ ai.id }}"></div>
            <div class="ai-reports" id="reports-{{ ai.id }}">
                <h5>Recent Reports</h5>
                <div class="reports-container"></div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.getElementById('addAIForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        role: formData.get('role'),
        skills: formData.get('skills')
    };

    try {
        const response = await fetch('/add_ai_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert(result.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
};

async function assignTask(aiId) {
    const task = prompt('Enter task description:');
    if (!task) return;

    try {
        const response = await fetch('/ai_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ai_id: aiId,
                task: task
            })
        });
        const result = await response.json();
        if (response.ok) {
            const responseDiv = document.getElementById(`response-${aiId}`);
            responseDiv.innerHTML = `
                <p><strong>Latest Task Response:</strong><br>${result.response}</p>
                ${result.report ? `
                    <div class="report-download">
                        <p>Report Generated:</p>
                        <a href="/download_report/${result.report}" class="download-btn">Download Report</a>
                    </div>
                ` : ''}
            `;
            updateReportsList();
        } else {
            alert(result.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function updateReportsList() {
    try {
        const response = await fetch('/get_ai_reports');
        const reports = await response.json();
        const reportsList = document.getElementById('reportsList');
        reportsList.innerHTML = reports.map(report => `
            <div class="report-item">
                <div class="report-info">
                    <h4>${report.title}</h4>
                    <p>Generated by: ${report.ai_name}</p>
                    <p>Date: ${new Date(report.created_at).toLocaleDateString()}</p>
                    <p>Type: ${report.type}</p>
                </div>
                <div class="report-actions">
                    <button onclick="viewReport('${report.id}')" class="view-btn">View</button>
                    <a href="/download_report/${report.id}" class="download-btn">Download</a>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error updating reports:', error);
    }
}

async function viewReport(reportId) {
    try {
        const response = await fetch(`/view_report/${reportId}`);
        const report = await response.json();
        // Create modal to display report
        const modal = document.createElement('div');
        modal.className = 'report-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close-btn" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h3>${report.title}</h3>
                <div class="report-content">${report.content}</div>
            </div>
        `;
        document.body.appendChild(modal);
    } catch (error) {
        console.error('Error viewing report:', error);
    }
}

// Initialize reports list and set up filters
document.addEventListener('DOMContentLoaded', () => {
    updateReportsList();
    
    document.getElementById('reportTypeFilter').addEventListener('change', updateReportsList);
    document.getElementById('dateFilter').addEventListener('change', updateReportsList);
});
</script>

<style>
.ai-employees-container {
    padding: 20px;
}

.add-ai-form {
    margin-bottom: 30px;
    padding: 20px;
    background: #f5f5f5;
    border-radius: 8px;
}

.reports-section {
    margin: 20px 0;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.reports-filters {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
}

.reports-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.report-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.report-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.ai-employees-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.ai-employee-card {
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.task-response {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #007bff;
}

.download-btn, .view-btn {
    padding: 5px 10px;
    border-radius: 4px;
    text-decoration: none;
    color: white;
    cursor: pointer;
}

.download-btn {
    background: #28a745;
}

.view-btn {
    background: #007bff;
}

.report-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 80%;
    max-height: 80%;
    overflow-y: auto;
    position: relative;
}

.close-btn {
    position: absolute;
    right: 10px;
    top: 10px;
    cursor: pointer;
    font-size: 24px;
}

button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background: #0056b3;
}
</style>
{% endblock %} 